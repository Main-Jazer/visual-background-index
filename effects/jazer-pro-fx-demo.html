<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pro FX Demo - JaZeR</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }

        .intro-overlay {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #00f5ff;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            padding: 15px 25px;
            border-radius: 10px;
            border: 1px solid rgba(0, 245, 255, 0.3);
            text-align: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
            animation: fadeOut 8s forwards;
        }

        @keyframes fadeOut {

            0%,
            80% {
                opacity: 1;
            }

            100% {
                opacity: 0;
                pointer-events: none;
            }
        }
    </style>
</head>

<body>
    <canvas id="c"></canvas>
    <div class="intro-overlay">
        <div style="color: #ff2aff; font-weight: bold; margin-bottom: 8px;">ðŸŽ¬ PRO FX DEMO</div>
        <div>Press <span style="color: #ffd700">[</span> or <span style="color: #ffd700">]</span> to cycle presets</div>
        <div>Press <span style="color: #ffd700">P</span> to toggle effects</div>
        <div>Press <span style="color: #ffd700">H</span> to toggle HUD</div>
    </div>

    <script type="module">
        import { noise2D, noise3D, mouse, hexToRgb } from '../lib/engine/jazer-background-engine.js';
        import '../lib/engine/jazer-navigation.js';
        import { initProFX } from '../lib/fx/post/jazer-pro-fx.js';
        import { attachEffectUI } from '../lib/engine/jazer-effect-ui-schema.js';

        const __jazerEffectFile = location.pathname.split('/').pop() || '';
        const __jazerEffectName = __jazerEffectFile.replace(/\.html$/i, '');
        const { ui, expose, ready } = attachEffectUI({
            title: document.title,
            schemaUrl: new URL(`./ui-schema/${__jazerEffectName}.ui.json`, import.meta.url)
        });
        window.JAZER_UI = ui;
        window.JAZER_EXPOSE = expose;
        window.JAZER_UI_READY = ready;

        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('2d');
        const dpr = Math.min(window.devicePixelRatio || 1, 2);
        let W, H;
        let time = 0;

        // Initialize Pro FX with HUD enabled
        const fx = initProFX(canvas, {
            preset: 'neon',
            showHUD: true
        });

        const colors = ['#ff0055', '#ff2aff', '#00f5ff', '#39ff14', '#ffd700'];

        class Particle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * W;
                this.y = Math.random() * H;
                this.size = 2 + Math.random() * 4;
                this.speedX = (Math.random() - 0.5) * 2;
                this.speedY = (Math.random() - 0.5) * 2;
                this.colorIndex = Math.floor(Math.random() * colors.length);
                this.life = 1;
                this.decay = 0.002 + Math.random() * 0.005;
            }
            update() {
                const attractStrength = window.JAZER_UI?.params?.attractStrength ?? 0.3;
                const noiseStrength = window.JAZER_UI?.params?.noiseStrength ?? 0.2;
                // Mouse attraction
                const mx = mouse.x * W;
                const my = mouse.y * H;
                const dx = mx - this.x;
                const dy = my - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 300 && dist > 10) {
                    this.speedX += (dx / dist) * attractStrength;
                    this.speedY += (dy / dist) * attractStrength;
                }

                // Noise-based movement
                this.speedX += noise2D(this.x * 0.005, time) * noiseStrength;
                this.speedY += noise2D(this.y * 0.005, time + 100) * noiseStrength;

                // Damping
                this.speedX *= 0.98;
                this.speedY *= 0.98;

                this.x += this.speedX;
                this.y += this.speedY;
                this.life -= this.decay;

                if (this.life <= 0 || this.x < -50 || this.x > W + 50 || this.y < -50 || this.y > H + 50) {
                    this.reset();
                }
            }
            draw(ctx) {
                const color = colors[this.colorIndex];
                const rgb = hexToRgb(color);
                const alpha = this.life * 0.8;

                // Outer glow
                const grad = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size * 3);
                grad.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha * 0.5})`);
                grad.addColorStop(0.5, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha * 0.2})`);
                grad.addColorStop(1, 'rgba(0, 0, 0, 0)');
                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size * 3, 0, Math.PI * 2);
                ctx.fill();

                // Core
                ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        let particles = [];

        function resize() {
            W = window.innerWidth;
            H = window.innerHeight;
            canvas.width = W * dpr;
            canvas.height = H * dpr;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        function drawScene(ctx, w, h) {
            // Background
            const bgGrad = ctx.createRadialGradient(W / 2, H / 2, 0, W / 2, H / 2, Math.max(W, H));
            bgGrad.addColorStop(0, '#0a0015');
            bgGrad.addColorStop(1, '#000008');
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, W, H);

            // Update and draw particles
            ctx.save();
            ctx.globalCompositeOperation = 'lighter';
            particles.forEach(p => { p.update(); p.draw(ctx); });
            ctx.restore();

            // Draw connections between nearby particles
            ctx.save();
            ctx.globalCompositeOperation = 'lighter';
            const connectionDistance = window.JAZER_UI?.params?.connectionDistance ?? 150;
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dx = particles[j].x - particles[i].x;
                    const dy = particles[j].y - particles[i].y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < connectionDistance) {
                        const alpha = (1 - dist / connectionDistance) * 0.3 * particles[i].life * particles[j].life;
                        ctx.strokeStyle = `rgba(0, 245, 255, ${alpha})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.stroke();
                    }
                }
            }
            ctx.restore();

            // Title text
            ctx.save();
            ctx.globalCompositeOperation = 'lighter';
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const textGrad = ctx.createLinearGradient(W / 2 - 150, 0, W / 2 + 150, 0);
            textGrad.addColorStop(0, colors[Math.floor(time) % colors.length]);
            textGrad.addColorStop(0.5, colors[Math.floor(time + 1) % colors.length]);
            textGrad.addColorStop(1, colors[Math.floor(time + 2) % colors.length]);

            ctx.fillStyle = textGrad;
            ctx.globalAlpha = 0.15 + Math.sin(time * 2) * 0.05;
            ctx.fillText('JaZeR', W / 2, H / 2);
            ctx.restore();
        }

        function reseed() {
            const count = Math.max(20, Math.round(window.JAZER_UI?.params?.particleCount ?? 200));
            particles = Array.from({ length: count }, () => new Particle());
        }

        expose('reseed', reseed);
        expose('prevPreset', () => fx.prevPreset());
        expose('nextPreset', () => fx.nextPreset());
        expose('toggleFX', () => fx.toggle());
        expose('toggleHUD', () => fx.toggleHUD());

        function animate() {
            const timeScale = window.JAZER_UI?.params?.timeScale ?? 1;
            const dt = (1 / 60) * timeScale;
            time += dt;
            mouse.update();

            // Render with Pro FX post-processing
            fx.render(drawScene, dt);

            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', resize);
        resize();
        reseed();
        animate();
    </script>
</body>

</html>
