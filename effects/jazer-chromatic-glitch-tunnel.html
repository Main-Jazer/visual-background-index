<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JaZeR Chromatic Glitch Tunnel</title>
  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", system-ui, sans-serif;
      background: radial-gradient(circle at 25% 20%, #08071a, #010107 65%);
      color: #dfe3ff;
      min-height: 100vh;
      overflow: hidden;
    }

    canvas {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      display: block;
    }

    .label {
      position: fixed;
      left: 2rem;
      bottom: 2rem;
      font-size: 0.85rem;
      letter-spacing: 0.3em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.35);
      pointer-events: none;
    }
  </style>
</head>
<body>
  <canvas id="effect"></canvas>
  <div class="label">Chromatic Glitch Tunnel</div>
  <script type="module">
    import { mouse, noise2D, ColorPalettes } from '../lib/jazer-background-engine.js';

    const canvas = document.getElementById('effect');
    const ctx = canvas.getContext('2d');
    const palette = ColorPalettes.cyberpunk || ColorPalettes.jazer;

    const slices = [];
    const sparks = [];
    let width = 0;
    let height = 0;
    let lastTime = 0;

    const SLICE_COUNT = 140;
    const SPARK_COUNT = 45;

    class Slice {
      constructor(depth) {
        this.reset(depth);
      }

      reset(depth) {
        this.depth = depth;
        this.angle = Math.random() * Math.PI * 2;
        this.span = 0.5 + Math.random() * 1.8;
        this.radius = 0.25 + Math.random() * 0.25;
        this.speed = 0.25 + Math.random() * 0.35;
        this.color = palette[Math.floor(Math.random() * palette.length)] || '#00f5ff';
        this.glitch = 0;
        this.glitchOffsetX = 0;
        this.glitchOffsetY = 0;
      }

      tick(dt) {
        this.depth -= dt * this.speed;
        if (this.depth <= 0) {
          this.reset(1);
        }

        if (Math.random() < 0.018) {
          this.glitch = 0.28;
          this.glitchOffsetX = (Math.random() - 0.5) * 50;
          this.glitchOffsetY = (Math.random() - 0.5) * 40;
        }

        if (this.glitch > 0) {
          this.glitch -= dt;
          if (this.glitch <= 0) {
            this.glitchOffsetX = 0;
            this.glitchOffsetY = 0;
          }
        }

        this.angle += dt * (0.5 - this.depth * 0.25);
      }
    }

    class Spark {
      constructor() {
        this.reset();
      }

      reset() {
        this.depth = Math.random();
        this.angle = Math.random() * Math.PI * 2;
        this.speed = 0.4 + Math.random() * 0.4;
        this.length = 30 + Math.random() * 40;
        this.alpha = 0.2 + Math.random() * 0.3;
      }

      tick(dt) {
        this.depth -= dt * this.speed;
        if (this.depth <= 0) {
          this.reset();
        }
      }
    }

    function setup() {
      for (let i = 0; i < SLICE_COUNT; i++) {
        slices.push(new Slice(i / SLICE_COUNT));
      }
      for (let i = 0; i < SPARK_COUNT; i++) {
        sparks.push(new Spark());
      }
      resize();
      requestAnimationFrame(render);
    }

    function resize() {
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width * dpr;
      canvas.height = height * dpr;
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    window.addEventListener('resize', resize);

    function render(now) {
      const dt = (now - lastTime) / 1000 || 0;
      lastTime = now;
      mouse.update();

      ctx.clearRect(0, 0, width, height);
      drawBackground();
      drawSlices(dt);
      drawSparks(dt);
      drawArtifacts();

      requestAnimationFrame(render);
    }

    function drawBackground() {
      const gradient = ctx.createRadialGradient(width * 0.5, height * 0.4, 50, width * 0.5, height * 0.5, Math.max(width, height));
      gradient.addColorStop(0, '#050412');
      gradient.addColorStop(1, '#010005');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, width, height);
    }

    function drawSlices(dt) {
      ctx.save();
      ctx.translate(width / 2, height / 2);
      ctx.globalCompositeOperation = 'lighter';

      slices.forEach(slice => {
        slice.tick(dt);

        const depth = Math.pow(1 - slice.depth, 1.75);
        const baseRadius = Math.min(width, height) * slice.radius + slice.depth * 420;
        const thickness = Math.max(1, depth * 6);
        const wobble = noise2D(slice.angle, lastTime * 0.0008) * 30;

        const offsetX = mouse.centeredX * slice.depth * 160 + wobble + slice.glitchOffsetX;
        const offsetY = mouse.centeredY * slice.depth * 100 + slice.glitchOffsetY;

        const colors = [
          '#ff2aff',
          slice.color,
          '#00f5ff'
        ];

        colors.forEach((color, channel) => {
          const shift = (channel - 1) * 10;
          ctx.strokeStyle = `${color}${Math.floor(depth * 200).toString(16).padStart(2, '0')}`;
          ctx.lineWidth = thickness + channel;
          ctx.beginPath();
          ctx.arc(offsetX + shift, offsetY - shift * 0.6, baseRadius, slice.angle, slice.angle + slice.span);
          ctx.stroke();
        });
      });

      const core = ctx.createRadialGradient(0, 0, 0, 0, 0, 120);
      core.addColorStop(0, '#ffffff');
      core.addColorStop(1, '#00000000');
      ctx.fillStyle = core;
      ctx.beginPath();
      ctx.arc(0, 0, 140, 0, Math.PI * 2);
      ctx.fill();

      ctx.restore();
    }

    function drawSparks(dt) {
      ctx.save();
      ctx.translate(width / 2, height / 2);
      ctx.globalCompositeOperation = 'lighter';

      sparks.forEach(spark => {
        spark.tick(dt);
        const depth = Math.pow(1 - spark.depth, 2);
        const radius = depth * (Math.min(width, height) * 0.55);
        const angle = spark.angle + lastTime * 0.0003;
        const x = Math.cos(angle) * radius + mouse.centeredX * 70;
        const y = Math.sin(angle) * radius * 0.6 + mouse.centeredY * 50 - depth * 40;

        ctx.strokeStyle = `rgba(255,255,255,${spark.alpha * depth})`;
        ctx.lineWidth = 1.3;
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x * 0.8, y * 0.8);
        ctx.stroke();
      });

      ctx.restore();
    }

    function drawArtifacts() {
      ctx.save();
      ctx.globalAlpha = 0.08;
      ctx.fillStyle = '#05050b';
      for (let y = 0; y < height; y += 3) {
        ctx.fillRect(0, y, width, 1);
      }
      ctx.restore();

      if (Math.random() < 0.08) {
        const glitchY = Math.random() * height;
        ctx.fillStyle = 'rgba(255,255,255,0.08)';
        ctx.fillRect(0, glitchY, width, 2);
      }

      if (Math.random() < 0.03) {
        const glitchX = Math.random() * width;
        ctx.fillStyle = 'rgba(255,255,255,0.05)';
        ctx.fillRect(glitchX, 0, 2, height);
      }
    }

    setup();
  </script>
</body>
</html>
