<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JaZeR Particle Warp - Infinite Loop</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: block;
        }
    </style>
</head>

<body>
    <canvas id="c"></canvas>
    <script type="module">
        import {
            noise2D, mouse, Easing,
            ColorPalettes, cycleColor, hexToRgb,
            map, clamp, smoothstep, distance
        } from '../jazer-background-engine.js';

        // =====================================================
        // CONFIGURATION
        // =====================================================
        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('2d');
        const dpr = Math.min(window.devicePixelRatio || 1, 2);
        let W, H, cx, cy;
        let time = 0;

        // Neon color palette
        const neonPalette = ['#00ffff', '#ff00ff', '#9d00ff', '#00ccff', '#ff1aff'];
        
        // Particle parameters
        const particleCount = 300;      // Number of warp particles
        const spawnRate = 5;            // Particles per frame
        const warpSpeed = 400;          // How fast particles fly outward
        const trailLength = 0.08;       // Motion blur trail length
        
        // Particle array
        const particles = [];

        // =====================================================
        // RESIZE HANDLER
        // =====================================================
        function resize() {
            W = window.innerWidth;
            H = window.innerHeight;
            cx = W / 2;
            cy = H / 2;
            canvas.width = W * dpr;
            canvas.height = H * dpr;
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        // =====================================================
        // WARP PARTICLE CLASS
        // =====================================================
        /**
         * WarpParticle represents a single particle streaming backward from the center.
         * Creates a Star Wars hyperspace-like effect with motion blur trails.
         */
        class WarpParticle {
            constructor() {
                this.reset();
            }

            /**
             * Reset particle to center position
             */
            reset() {
                // Start at center with slight random offset
                this.x = cx + (Math.random() - 0.5) * 20;
                this.y = cy + (Math.random() - 0.5) * 20;
                
                // Random direction (angle from center)
                this.angle = Math.random() * Math.PI * 2;
                
                // Random speed variation
                this.speed = warpSpeed * (0.7 + Math.random() * 0.6);
                
                // Velocity components
                this.vx = Math.cos(this.angle) * this.speed;
                this.vy = Math.sin(this.angle) * this.speed;
                
                // Visual properties
                this.size = 1 + Math.random() * 2;
                const colorIndex = Math.floor(Math.random() * neonPalette.length);
                this.color = neonPalette[colorIndex];
                this.life = 1.0;
                
                // Store previous position for trail
                this.prevX = this.x;
                this.prevY = this.y;
                
                // Random acceleration (particles speed up as they go)
                this.acceleration = 1 + Math.random() * 0.5;
            }

            /**
             * Update particle position and velocity
             * @param {number} dt - Delta time in seconds
             */
            update(dt) {
                // Store previous position for trail
                this.prevX = this.x;
                this.prevY = this.y;
                
                // Accelerate over time (hyperspace acceleration effect)
                this.speed *= (1 + this.acceleration * dt);
                this.vx = Math.cos(this.angle) * this.speed;
                this.vy = Math.sin(this.angle) * this.speed;
                
                // Update position
                this.x += this.vx * dt;
                this.y += this.vy * dt;
                
                // Calculate distance from center
                const distFromCenter = distance(this.x, this.y, cx, cy);
                
                // Fade out as particle gets further from center
                this.life = smoothstep(Math.max(W, H), Math.max(W, H) * 0.6, distFromCenter);
                
                // Reset if particle is off screen or too far
                if (distFromCenter > Math.max(W, H) || this.life <= 0) {
                    this.reset();
                }
            }

            /**
             * Draw particle with motion blur trail
             */
            draw() {
                if (this.life <= 0.01) return;
                
                const rgb = hexToRgb(this.color);
                
                // Draw motion blur trail line
                ctx.save();
                ctx.globalCompositeOperation = 'lighter';
                
                // Calculate trail length based on speed
                const trailFactor = Math.min(1, this.speed / warpSpeed / 2);
                
                // Create gradient for trail (from previous position to current)
                const gradient = ctx.createLinearGradient(
                    this.prevX, this.prevY,
                    this.x, this.y
                );
                gradient.addColorStop(0, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0)`);
                gradient.addColorStop(1, `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${this.life * trailFactor})`);
                
                // Draw trail line
                ctx.strokeStyle = gradient;
                ctx.lineWidth = this.size * (1 + trailFactor);
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 10 * trailFactor;
                
                ctx.beginPath();
                ctx.moveTo(this.prevX, this.prevY);
                ctx.lineTo(this.x, this.y);
                ctx.stroke();
                
                // Draw particle head (brighter point)
                ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${this.life})`;
                ctx.shadowBlur = 15;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size * 1.5, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }
        }

        // =====================================================
        // INITIALIZATION
        // =====================================================
        /**
         * Initialize particle system
         */
        function init() {
            particles.length = 0;
            for (let i = 0; i < particleCount; i++) {
                particles.push(new WarpParticle());
            }
        }

        // =====================================================
        // CENTRAL LOGO DRAWING
        // =====================================================
        /**
         * Draw the central "JaZeR" logo
         */
        function drawCentralLogo() {
            // Pulsing glow effect
            const pulse = Math.sin(time * 2) * 0.2 + 0.8;
            const glowColor = cycleColor(neonPalette, time * 0.3);
            const rgb = hexToRgb(glowColor);
            
            // Configure text
            ctx.font = 'bold 60px "Arial", sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            ctx.save();
            
            // Outer glow layers
            ctx.shadowColor = glowColor;
            ctx.shadowBlur = 40 * pulse;
            ctx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${pulse})`;
            
            // Draw logo multiple times for intense glow
            for (let i = 0; i < 4; i++) {
                ctx.fillText('JaZeR', cx, cy);
            }
            
            // Inner bright core
            ctx.shadowBlur = 20;
            ctx.fillStyle = '#ffffff';
            ctx.fillText('JaZeR', cx, cy);
            
            // Draw circular rings around logo
            ctx.globalCompositeOperation = 'lighter';
            ctx.strokeStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${pulse * 0.5})`;
            ctx.lineWidth = 2;
            ctx.shadowBlur = 20 * pulse;
            
            for (let r = 1; r <= 3; r++) {
                const radius = 80 + r * 15 + Math.sin(time * 3 + r) * 5;
                ctx.beginPath();
                ctx.arc(cx, cy, radius, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            ctx.restore();
        }

        // =====================================================
        // ANIMATION LOOP
        // =====================================================
        /**
         * Main render loop
         */
        function render(now) {
            const dt = 1 / 60; // Assume 60fps
            time += dt;
            
            // Update mouse tracking
            mouse.update();
            
            // Clear canvas with slight fade for trail effect
            ctx.fillStyle = `rgba(0, 0, 10, ${trailLength})`;
            ctx.fillRect(0, 0, W, H);
            
            // Draw radial gradient background (adds depth)
            const bgGradient = ctx.createRadialGradient(cx, cy, 0, cx, cy, Math.max(W, H) * 0.7);
            bgGradient.addColorStop(0, 'rgba(20, 0, 30, 0)');
            bgGradient.addColorStop(1, 'rgba(0, 0, 10, 0.3)');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, W, H);
            
            // Update and draw all particles
            for (const particle of particles) {
                particle.update(dt);
                particle.draw();
            }
            
            // Draw the central JaZeR logo on top
            drawCentralLogo();
            
            requestAnimationFrame(render);
        }

        // =====================================================
        // START THE EFFECT
        // =====================================================
        window.addEventListener('resize', resize);
        resize();
        init();
        requestAnimationFrame(render);
    </script>
</body>

</html>
